name: singularity-hpc-test-registry

on:
  # TODO: update this to be labels and binoc updates
  pull_request: []
#    types: [labeled]
#    branches:
#      - recipe/*

jobs:
  test-registry:
#    if: ${{ github.event.label.name == 'container-recipe' }}
    runs-on: ubuntu-latest
    container: centos:7
    steps:
      - name: Derive number of commits
        run: |
            yum install -y git
            git clone https://github.com/${GITHUB_REPOSITORY}
            cd singularity-hpc
            git fetch
            git checkout ${GITHUB_REF##*/}
            commits=$(git rev-list --count origin/main)
            echo "Found $commits since main"
            cd registry
            touch changes.txt
            for container_yaml in $(git diff --name-only HEAD~$commits..HEAD .)
                echo $changes >> changes.txt

      - name: install Lmod
        run: |
            yum install -y epel-release && \
            yum update -y && \
            yum install -y lua lua-filesystem lua-posix wget gcc
            yum install -y Lmod singularity git

      - name: Install conda
        run: |
          CONDA_SCRIPT=Miniconda3-latest-Linux-x86_64.sh
          wget https://repo.anaconda.com/miniconda/$CONDA_SCRIPT
          /bin/bash $CONDA_SCRIPT -b -p /usr/share/miniconda
          export PATH="/usr/share/miniconda/bin:$PATH"
          conda create --quiet --name shpc -c conda-forge spython

      - uses: actions/checkout@v2
      - name: Install shpc
        run: |
          export PATH="/usr/share/miniconda/bin:$PATH"
          source activate shpc
          pip install -e .

      - name: Run module tests
        run: |
          export PATH="/usr/share/miniconda/bin:$PATH"
          source activate shpc
          # Test each module file that is changed (there should be just one commit)
          cd registry
          for container_yaml in $(cat changes.txt); do
              . /usr/share/lmod/lmod/init/sh
              module=$(dirname $container_yaml)
              module=$(echo "${module/registry\//}")
              echo "Testing $module"
              shpc test $module
              # TODO test adding tests when this works
          done
